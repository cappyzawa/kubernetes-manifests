apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: concourse-worker
spec:
  serviceName: concourse-worker
  replicas: 2
  selector:
    matchLabels:
      app: concourse-worker
  template:
    metadata:
      labels:
        app: concourse-worker
    spec:
      serviceAccountName: concourse-worker
      tolerations: []
      terminationGracePeriodSeconds: 60
      containers:
        - name: concourse-worker
          image: "concourse/concourse:4.2.2"
          imagePullPolicy: IfNotPresent
          args:
            - worker
            - |
              --name=${HOSTNAME}
          env:
            - name: CONCOURSE_WORK_DIR
              value: "/concourse-work-dir"
            - name: CONCOURSE_TSA_HOST
              value: "concourse-web:2222"
            - name: CONCOURSE_TSA_PUBLIC_KEY
              value: "/concourse-keys/host_key.pub"
            - name: CONCOURSE_TSA_WORKER_PRIVATE_KEY
              value: "/concourse-keys/worker_key"
            - name: CONCOURSE_GARDEN_BIND_PORT
              value: "7777"
            - name: CONCOURSE_BAGGAGECLAIM_DRIVER
              valueFrom:
                configMapKeyRef:
                  key: baggageclaim-driver
                  name: concourse-worker
            - name: CONCOURSE_EPHEMERAL
              valueFrom:
                configMapKeyRef:
                  key: ephemeral
                  name: concourse-worker
            - name: CONCOURSE_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  key: log-level
                  name: concourse-worker
            - name: CONCOURSE_GARDEN_LOG_LEVEL
              value: $(CONCOURSE_LOG_LEVEL)
            - name: CONCOURSE_BAGGAGECLAIM_LOG_LEVEL
              value: $(CONCOURSE_LOG_LEVEL)
            
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
          securityContext:
            privileged: true
          volumeMounts:
            - mountPath: /concourse-keys
              name: concourse-keys
              readOnly: true
            - mountPath: /concourse-work-dir
              name: concourse-work-dir
      volumes:
        - name: concourse-keys
          secret:
            secretName: concourse
            defaultMode: 0400
            items:
            - key: host-key-pub
              path: host_key.pub
            - key: worker-key
              path: worker_key
            - key: worker-key-pub
              path: worker_key.pub
        - name: concourse-work-dir
          hostPath:
            path: /tmp/concourse-work-dir
            type: DirectoryOrCreate
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
